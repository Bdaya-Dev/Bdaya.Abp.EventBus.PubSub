version: '3.8'

services:
  # Build and publish NuGet package
  publish:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: ${PACKAGE_VERSION:-1.0.0}
    environment:
      - NUGET_API_KEY=${NUGET_API_KEY}
      - NUGET_SOURCE=${NUGET_SOURCE:-https://api.nuget.org/v3/index.json}

  # Run tests with Pub/Sub emulator
  test:
    build:
      context: .
      dockerfile: Dockerfile.test
    depends_on:
      - pubsub-emulator
    environment:
      - PUBSUB_EMULATOR_HOST=pubsub-emulator:8085
      - PUBSUB_PROJECT_ID=test-project

  # Pub/Sub emulator for testing
  pubsub-emulator:
    image: gcr.io/google.com/cloudsdktool/cloud-sdk:emulators
    command: gcloud beta emulators pubsub start --host-port=0.0.0.0:8085 --project=test-project
    ports:
      - "8085:8085"
